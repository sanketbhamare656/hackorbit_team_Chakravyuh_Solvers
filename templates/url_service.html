{% extends "base.html" %}
{% block content %}
<div id="particles-js"></div>

<!-- Main Container -->
<div class="container">
    <!-- Centered Header -->
    <a href="/" class="logo" style="text-align: center; display: block; margin: 0 auto;">
        <h1 itemprop="name" style="color: var(--primary);">PhishNet</h1>
    </a>

    <div class="short-note" style="text-align: center;">
        <p itemprop="description"><strong>A Digital Net Capturing Malicious Links! ðŸŽ£</strong><br>
            Stay secure online with <strong>PhishNet.</strong>
        </p>
    </div><br>

    <!-- URL Input Form -->
    <form method="post">
        <input type="text" name="url" placeholder="Enter URL to scan" required />
        <button type="submit" class="btn btn-primary">Verify URL</button>
    </form>

    <!-- Loader -->
    <div class="loader" id="loader" style="margin: 20px auto; display: none;"></div>

    <!-- Scan Console Output -->
    <div class="scan-console" style="text-align: center; font-family: monospace; color: #0f0; background-color: #000; padding: 15px; margin-top: 20px; border-radius: 5px; max-height: 300px; overflow-y: auto; display: none;"></div>

    {% if output != "NA" %}
    <!-- Result Section -->
    <div class="result" style="text-align: left;">
        {{ output|safe }}
    </div>
    {% endif %}
</div>

<!-- Particle.js -->
<script src="https://cdn.jsdelivr.net/particles.js/2.0.0/particles.min.js"></script>
<script>
    particlesJS("particles-js", {
        particles: {
            number: { value: 80, density: { enable: true, value_area: 800 } },
            color: { value: "#333" },
            shape: { type: "circle" },
            opacity: { value: 0.5, random: true },
            size: { value: 3, random: true },
            line_linked: { enable: true, distance: 150, color: "#333", opacity: 0.4, width: 1 },
            move: { enable: true, speed: 3 }
        },
        interactivity: {
            detect_on: "canvas",
            events: {
                onhover: { enable: true, mode: "repulse" },
                onclick: { enable: true, mode: "push" }
            },
            modes: {
                repulse: { distance: 100, duration: 0.4 },
                push: { particles_nb: 4 }
            }
        },
        retina_detect: true
    });

    function showConsole() {
        const console = document.querySelector('.scan-console');
        console.style.display = 'block';
        console.innerHTML = '';
    }

    function addConsoleLine(message, percent) {
        const console = document.querySelector('.scan-console');
        const line = document.createElement('div');
        line.className = 'console-line';
        line.style.display = 'none';

        if (percent !== undefined) {
            line.innerHTML = `&gt; ${message}<span class="progress-percent"> ${percent}%</span>`;
        } else {
            line.textContent = `> ${message}`;
        }

        console.appendChild(line);

        setTimeout(() => {
            const visibleLines = console.querySelectorAll('.console-line');
            visibleLines.forEach(el => el.style.display = 'none');
            line.style.display = 'block';
            console.scrollTop = console.scrollHeight;
        }, 100);
    }

    function simulateScan() {
        showConsole();
        const steps = [
            ["Fetching URL...", 5],
            ["Extracting domain...", 10],
            ["Validating URL format...", 15],
            ["Checking PhishTank database...", 20],
            ["Fetching domain rank...", 30],
            ["Fetching WHOIS information...", 40],
            ["Checking if URL is shortened...", 50],
            ["HSTS support: No", 60],
            ["Checking if IP is present in URL...", 70],
            ["IP present in URL: No", 75],
            ["Checking URL redirection...", 80],
            ["URL redirects: No", 85],
            ["Checking URL length...", 90],
            ["Too long URL: No", 95],
            ["Checking URL depth...", 100],
            ["Too deep URL: No"],
            ["Fetching IP address..."],
            ["IP address: 142.250.207.174"],
            ["Fetching SSL certificate..."],
            ["Generating trust score..."],
            ["Scan completed!"]
        ];

        steps.forEach((step, index) => {
            setTimeout(() => addConsoleLine(step[0], step[1]), 500 + index * 700);
        });
    }

    function showLoader() {
        document.getElementById('loader').style.display = 'block';
    }

    function hideLoader() {
        document.getElementById('loader').style.display = 'none';
    }

    document.addEventListener('DOMContentLoaded', function () {
        const form = document.querySelector('form');
        if (form) {
            form.addEventListener('submit', function (e) {
                e.preventDefault();
                simulateScan();
                showLoader();

                const formData = new FormData(this);
                fetch('/', {
                    method: 'POST',
                    body: formData
                })
                    .then(response => response.text())
                    .then(html => {
                        hideLoader();
                        const tempDiv = document.createElement('div');
                        tempDiv.innerHTML = html;

                        const newResult = tempDiv.querySelector('.result');
                        const currentResult = document.querySelector('.result');

                        if (currentResult) {
                            currentResult.replaceWith(newResult);
                        } else {
                            document.querySelector('.container').appendChild(newResult);
                        }
                    })
                    .catch(error => {
                        hideLoader();
                        console.error('Error:', error);
                        addConsoleLine(`Error: ${error.message}`);
                    });
            });
        }
    });
</script>
{% endblock %}